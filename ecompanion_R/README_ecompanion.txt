================================================================================
E-COMPANION REPRODUCIBILITY CODE (R SCRIPTS)
================================================================================
Paper: "Assortment and Price Optimization Under a Multi-Attribute 
        (Contextual) Choice Model"
        
This folder contains R scripts to reproduce the numerical experiments in 
Sections EC5.5 and EC6 of the E-companion.

================================================================================
SIMULATION ENVIRONMENT
================================================================================
- RStudio Version: 2024.12.0+467
- R Version: R/4.0.2 
- Required Package: pracma (for Lambert W function)
- Required Package: tidyverse (for data manipulation in analysis scripts)

To install required packages:
  install.packages("pracma")
  install.packages("tidyverse")

================================================================================
FOLDER STRUCTURE
================================================================================
ecompanion_R/
├── README_ecompanion.txt         # This file
├── GridSearch.R                  # Section EC5.5: Algorithm 2 performance
├── ComparePrices.R               # Section EC6: gamma_0 = gamma_k scenario
├── ComparePrices2.R              # Section EC6: gamma_0 < gamma_k scenario
├── ComparePrices3.R              # Section EC6: gamma_0 > gamma_k scenario
├── Analyzing_Outputs.R           # Aggregates results for Table EC.9
├── Analyzing_Outputs2.R          # Aggregates results for Table EC.11
├── Analyzing_Outputs3.R          # Aggregates results for Table EC.10
├── Results/                      # Output folder for gamma_equal scenario
├── Results2gamma0lessgammak/     # Output folder for gamma0_smaller scenario
├── Results3gamma0greatergammak/  # Output folder for gamma0_larger scenario
└── reference_outputs/            # Pre-computed results for verification
    ├── summary_table.csv         # Expected output for Table EC.9
    ├── summary_table2.csv        # Expected output for Table EC.11
    └── summary_table3.csv        # Expected output for Table EC.10

================================================================================
INPUT DATA (FROM PYTHON SCRIPTS)
================================================================================
The ComparePrices scripts require input files generated by the Python scripts 
in the main reproducibility package (see README.txt).

IMPORTANT: Before running the R scripts, create symbolic links OR copy the 
instance folders to the expected locations:

Option A - Symbolic Links (recommended):
  cd ecompanion_R/
  ln -s ../section62_instances/gamma_equal Instances
  ln -s ../section62_instances/gamma0_smaller Instances2gamma0lessgammak
  ln -s ../section62_instances/gamma0_larger Instances3gamma0greatergammak

Option B - Copy Folders:
  cp -r ../section62_instances/gamma_equal Instances
  cp -r ../section62_instances/gamma0_smaller Instances2gamma0lessgammak
  cp -r ../section62_instances/gamma0_larger Instances3gamma0greatergammak

Input file format:
  CC_parameters_<N>prod_<K>attr.csv   # CC model parameters
  MNL_parameters_<N>prod_<K>attr.csv  # MNL model parameters
  where: <N> is "05", "10", or "20"; <K> is "1", "3", or "5"

================================================================================
SECTION EC5.5: ALGORITHM 2 PERFORMANCE (Tables EC.7 and EC.8)
================================================================================

##### File: GridSearch.R
##### Functionality: Numerically examine the performance of Algorithm 2

DESCRIPTION:
Tests the Grid Search Algorithm (Algorithm 2) for joint assortment and pricing
optimization across different grid precision values (epsilon).

INPUTS:
- No external files required
- Parameters defined in script (see Section EC5.5 in paper)
- Products: N = 3 or N = 10 (modify N.prods variable)
- Attributes: K = 5
- Random seed: 12345

EPSILON VALUES TESTED:
{0.001, 0.002, 0.005, 0.01, 0.02, 0.05, 0.1, 0.2, 0.5, 1.0}

CORE FUNCTIONS:
- profit(p.vec): Calculates expected profit under CC model for given prices
- g.function(p, j, x, V): First-order condition equation for optimal pricing
- find.root(...): Numerical solver for optimal price given auxiliary variables
- v.bar: Upper bound on profit using Lambert W function (Lemma EC.2)
- p.bar: Upper bound on prices (Lemma EC.3)

OUTPUTS:
- max.profit.GridSearch: Highest profit achievable on the grid
- optimal.prices.GridSearch: Price vector yielding maximum profit

USAGE:
  # In R/RStudio:
  source("GridSearch.R")
  # Results printed to console for each epsilon value

================================================================================
SECTION EC6: JOINT ASSORTMENT AND PRICING COMPARISONS
================================================================================

Three parallel workflows for different gamma parameter scenarios:

--------------------------------------------------------------------------------
Scenario 1: gamma_0 = gamma_k (Table EC.9)
--------------------------------------------------------------------------------

##### File: ComparePrices.R
##### Functionality: Compare CC vs MNL pricing when gamma_0 = gamma_k

INPUTS:
- Instances/CC_parameters_<N>prod_<K>attr.csv
- Instances/MNL_parameters_<N>prod_<K>attr.csv

OUTPUTS:
- Results/CC_OptPrices_<N>prod_<K>attr.csv
- Results/MNL_OptPrices_<N>prod_<K>attr.csv

##### File: Analyzing_Outputs.R
##### Functionality: Aggregate results into summary statistics

INPUTS:
- All files in Results/ folder

OUTPUTS:
- summary_table.csv → Table EC.9

--------------------------------------------------------------------------------
Scenario 2: gamma_0 < gamma_k (Table EC.11)
--------------------------------------------------------------------------------

##### File: ComparePrices2.R
##### Functionality: Compare CC vs MNL pricing when gamma_0 < gamma_k

INPUTS:
- Instances2gamma0lessgammak/CC_parameters_<N>prod_<K>attr.csv
- Instances2gamma0lessgammak/MNL_parameters_<N>prod_<K>attr.csv

OUTPUTS:
- Results2gamma0lessgammak/CC_OptPrices_<N>prod_<K>attr.csv
- Results2gamma0lessgammak/MNL_OptPrices_<N>prod_<K>attr.csv

##### File: Analyzing_Outputs2.R
##### Functionality: Aggregate results into summary statistics

INPUTS:
- All files in Results2gamma0lessgammak/ folder

OUTPUTS:
- summary_table2.csv → Table EC.11

--------------------------------------------------------------------------------
Scenario 3: gamma_0 > gamma_k (Table EC.10)
--------------------------------------------------------------------------------

##### File: ComparePrices3.R
##### Functionality: Compare CC vs MNL pricing when gamma_0 > gamma_k

INPUTS:
- Instances3gamma0greatergammak/CC_parameters_<N>prod_<K>attr.csv
- Instances3gamma0greatergammak/MNL_parameters_<N>prod_<K>attr.csv

OUTPUTS:
- Results3gamma0greatergammak/CC_OptPrices_<N>prod_<K>attr.csv
- Results3gamma0greatergammak/MNL_OptPrices_<N>prod_<K>attr.csv

##### File: Analyzing_Outputs3.R
##### Functionality: Aggregate results into summary statistics

INPUTS:
- All files in Results3gamma0greatergammak/ folder

OUTPUTS:
- summary_table3.csv → Table EC.10

================================================================================
CORE FUNCTIONS IN COMPAREPRICES SCRIPTS
================================================================================

CC Model Functions:
- profit(p.vec): Expected profit under CC model
- utility(p.vec): Customer surplus (log-sum formula)
- g.function(p, j, x, V): FOC equation for optimal pricing
- find.root(...): Numerical solver for optimal price

MNL Model Functions:
- MNL_profit(markup): Profit under constant markup policy
- MNL_find_max_profit(): Grid search over markup values

Bound Calculations (Lemmas EC.2 and EC.3):
- v.bar: Upper bound on profit using Lambert W function
- p.bar: Upper bound on prices (maximum of three components)

================================================================================
EXECUTION ORDER
================================================================================

1. First, run Python scripts to generate instance files (see README.txt)

2. Create symbolic links or copy instance folders (see INPUT DATA section above)

3. Run ComparePrices scripts:
   # For local execution:
   source("ComparePrices.R")   # Run 9 times with SGE_TASK_ID = 1 to 9
   source("ComparePrices2.R")  # Run 9 times with SGE_TASK_ID = 1 to 9
   source("ComparePrices3.R")  # Run 9 times with SGE_TASK_ID = 1 to 9
   
   # For cluster execution (Sun Grid Engine):
   qsub -t 1-9 ComparePrices.R
   qsub -t 1-9 ComparePrices2.R
   qsub -t 1-9 ComparePrices3.R

4. Run analysis scripts to generate summary tables:
   source("Analyzing_Outputs.R")   # Generates summary_table.csv
   source("Analyzing_Outputs2.R")  # Generates summary_table2.csv
   source("Analyzing_Outputs3.R")  # Generates summary_table3.csv

================================================================================
NOTES ON CLUSTER EXECUTION
================================================================================

The ComparePrices scripts are designed for Sun Grid Engine (SGE) cluster 
execution using array jobs. The SGE_TASK_ID environment variable (1-9) 
determines which (N, K) combination to run:

  Task ID | N (products) | K (attributes)
  --------|--------------|---------------
     1    |      5       |       1
     2    |      5       |       3
     3    |      5       |       5
     4    |     10       |       1
     5    |     10       |       3
     6    |     10       |       5
     7    |     20       |       1
     8    |     20       |       3
     9    |     20       |       5

For local execution without SGE, modify the scripts to set:
  repetition.RANDOM.SEED = <task_id>  # 1 through 9

================================================================================
OUTPUT FILE FORMAT
================================================================================

CC_OptPrices_*.csv and MNL_OptPrices_*.csv contain:
- Instance: Instance number (1-100)
- N: Number of products
- K: Number of attributes
- L: Number of attribute levels (always 3)
- Exp Profit: Expected profit
- p_1, p_2, ..., p_N: Optimal prices for each product
- surplus: Customer surplus

summary_table*.csv contains (11 columns):
- Columns 1-3: CC prices (Mean, Min, Max)
- Column 4: CC mean surplus
- Column 5: CC mean profit
- Columns 6-8: MNL prices (Mean, Min, Max)
- Column 9: MNL mean surplus
- Column 10: MNL mean profit under CC model
- Column 11: Profit loss percentage ((CC - MNL) / CC * 100)

================================================================================
REFERENCE OUTPUTS FOR VERIFICATION
================================================================================

The reference_outputs/ folder contains pre-computed summary tables that can be 
used to verify your results:

  reference_outputs/
  ├── summary_table.csv    # Expected output for Table EC.9 (gamma_0 = gamma_k)
  ├── summary_table2.csv   # Expected output for Table EC.11 (gamma_0 < gamma_k)
  └── summary_table3.csv   # Expected output for Table EC.10 (gamma_0 > gamma_k)

After running the full pipeline, compare your generated summary_table*.csv files 
against these reference outputs. Results should match exactly (or within small 
numerical tolerance due to floating-point arithmetic).

================================================================================
